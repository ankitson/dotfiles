# ===================
# SSH Agent Setup
# ===================
{{- if eq .chezmoi.os "darwin" }}
# macOS: Use system ssh-agent (managed by launchd) with Keychain integration
if [ -z "$SSH_AUTH_SOCK" ]; then
  export SSH_AUTH_SOCK="$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
  # Fallback to default macOS agent socket if 1Password isn't available
  if [ ! -S "$SSH_AUTH_SOCK" ]; then
    export SSH_AUTH_SOCK="$(launchctl getenv SSH_AUTH_SOCK 2>/dev/null)"
  fi
fi
# Add default key from Keychain (no-op if already added)
ssh-add --apple-load-keychain 2>/dev/null
{{- else }}
# Linux: Start ssh-agent if not running, reuse existing via env file
_ssh_agent_env="$HOME/.ssh/agent.env"

_start_ssh_agent() {
  ssh-agent -s > "$_ssh_agent_env"
  chmod 600 "$_ssh_agent_env"
  . "$_ssh_agent_env" > /dev/null
  # Add default key if it exists
  [ -f "$HOME/.ssh/id_ed25519" ] && ssh-add "$HOME/.ssh/id_ed25519" 2>/dev/null
  [ -f "$HOME/.ssh/id_rsa" ] && ssh-add "$HOME/.ssh/id_rsa" 2>/dev/null
}

if [ -z "$SSH_AUTH_SOCK" ]; then
  # No agent in environment â€” check for saved env file
  if [ -f "$_ssh_agent_env" ]; then
    . "$_ssh_agent_env" > /dev/null
    # Verify the agent is still running
    if ! kill -0 "$SSH_AGENT_PID" 2>/dev/null; then
      _start_ssh_agent
    fi
  else
    _start_ssh_agent
  fi
fi

unset _ssh_agent_env
unset -f _start_ssh_agent
{{- end }}

# ===================
# Source .bashrc
# ===================
# source .bashrc for login shells (e.g. SSH)
if [ -f "$HOME/.bashrc" ]; then
  . "$HOME/.bashrc"
fi
