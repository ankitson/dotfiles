local wezterm = require 'wezterm'
local act = wezterm.action

local config = {}

-- =========================
-- Shell
-- =========================
{{ if eq .chezmoi.os "windows" -}}
config.default_prog = { "powershell.exe" }
{{ else if stat "/opt/homebrew/bin/bash" -}}
config.default_prog = { "/opt/homebrew/bin/bash", "-l" }
{{ else -}}
config.default_prog = { "/bin/bash", "-l" }
{{ end -}}

-- =========================
-- Look & feel
-- =========================

-- ------------------------------------------------------------
-- Quake-style initial window placement
-- ------------------------------------------------------------
wezterm.on('gui-startup', function(cmd)
  local screen = wezterm.gui.screens().active
  local width = screen.width
  local height = math.floor(screen.height * 0.30)

  local tab, pane, window = wezterm.mux.spawn_window(cmd or {})

  window:gui_window():set_position(screen.x, screen.y)
  window:gui_window():set_inner_size(width, height)
end)

config.font = wezterm.font_with_fallback {
  'JetBrainsMono Nerd Font',
  'JetBrains Mono',
  'Noto Color Emoji',
}
config.font_size = 16.0

config.color_scheme = "GruvboxDark"

config.window_background_opacity = 0.85
{{ if eq .chezmoi.os "darwin" -}}
config.macos_window_background_blur = 12
{{ end -}}

config.freetype_load_target = 'Light'
config.freetype_render_target = 'HorizontalLcd'
config.warn_about_missing_glyphs = false

-- =========================
-- Terminal behavior
-- =========================
config.term = 'xterm-256color'
config.scrollback_lines = 100000
config.enable_scroll_bar = false
config.hide_tab_bar_if_only_one_tab = true
config.use_fancy_tab_bar = true
config.tab_bar_at_bottom = false
config.window_close_confirmation = 'AlwaysPrompt'
config.audible_bell = 'Disabled'

-- =========================
-- Multiplexing (SSHMUX)
-- =========================
config.ssh_domains = wezterm.default_ssh_domains()

-- =========================
-- Leader + keybindings (tmux-ish)
-- =========================
config.leader = { key = '`', mods = 'NONE', timeout_milliseconds = 500 }

-- F12 passthrough
config.key_tables = {
  passthrough = {
    { key = 'F12', action = act.PopKeyTable }, -- toggle off
  },
}

config.keys = {
  -- Toggle passthrough: when ON, wezterm stops intercepting keys
  -- so your inner/remote tmux receives them (like your F12 tmux mode).
  -- {
  --   key = 'F12',
  --   action = act.ActivateKeyTable {
  --     name = 'passthrough',
  --     one_shot = false,
  --     until_unknown = true,   -- unknown keys pass through to the app
  --     replace_current = true,
  --   },
  -- },

  -- Send literal backtick (like tmux "send-prefix")
  { key = '`', mods = 'LEADER', action = act.SendKey { key = '`' } },

  -- Tabs
  { key = 'c', mods = 'LEADER', action = act.SpawnTab 'CurrentPaneDomain' },
  { key = 'n', mods = 'LEADER', action = act.ActivateTabRelative(1) },
  { key = 'p', mods = 'LEADER', action = act.ActivateTabRelative(-1) },
  { key = 'x', mods = 'LEADER', action = act.CloseCurrentTab { confirm = true } },

  -- Splits
  { key = '-', mods = 'LEADER', action = act.SplitVertical { domain = 'CurrentPaneDomain' } },
  { key = '|', mods = 'LEADER', action = act.SplitHorizontal { domain = 'CurrentPaneDomain' } },

  -- Pane navigation (hjkl)
  { key = 'LeftArrow', mods = 'LEADER', action = act.ActivatePaneDirection 'Left' },
  { key = 'DownArrow', mods = 'LEADER', action = act.ActivatePaneDirection 'Down' },
  { key = 'UpArrow', mods = 'LEADER', action = act.ActivatePaneDirection 'Up' },
  { key = 'RightArrow', mods = 'LEADER', action = act.ActivatePaneDirection 'Right' },

  -- Zoom pane
  { key = 'z', mods = 'LEADER', action = act.TogglePaneZoomState },

  -- Copy/search/palette
  { key = 'P', mods = 'LEADER', action = act.ActivateCommandPalette },
}

-- Status hint when passthrough is active
wezterm.on('update-right-status', function(window, _pane)
  if window:active_key_table() == 'passthrough' then
    window:set_right_status('PASS')
  else
    window:set_right_status('')
  end
end)

return config
