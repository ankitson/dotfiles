# If not running interactively, don't do anything
case $- in
    *i*) ;;
      *) return;;
esac

# history
shopt -s histappend
HISTSIZE=100000
HISTFILESIZE=200000

# check the window size after each command and, if necessary,
# update the values of LINES and COLUMNS.
shopt -s checkwinsize

# bash prompt
if [ -z "${debian_chroot:-}" ] && [ -r /etc/debian_chroot ]; then
    debian_chroot=$(cat /etc/debian_chroot)
fi
case "$TERM" in
    xterm-color|*-256color) color_prompt=yes;;
esac

GIT_PS1_SHOWDIRTYSTATE=1
[ -f "$HOME/.git-branch.sh" ] && source "$HOME/.git-branch.sh"

if [ "$color_prompt" = yes ]; then
  if type __git_ps1 &>/dev/null; then
    PS1='\[\033[33m\][\D{%y/%m/%d %H:%M}]\[\033[0m\]${debian_chroot:+($debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]$(__git_ps1 " (%s)")\$ '
  else
    PS1='${debian_chroot:+($debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
  fi
else
  PS1='${debian_chroot:+($debian_chroot)}\u@\h:\w\$ '
fi
unset color_prompt force_color_prompt

case "$TERM" in
xterm*|rxvt*)
    PS1="\[\e]0;${debian_chroot:+($debian_chroot)}\u@\h: \w\a\]$PS1"
    ;;
esac

# Bash completion
if ! shopt -oq posix; then
  if [ -f /usr/share/bash-completion/bash_completion ]; then
    . /usr/share/bash-completion/bash_completion
  elif [ -f /etc/bash_completion ]; then
    . /etc/bash_completion
  fi
fi

# ===========
# Environment
# ===========
{{ if lookPath "nvim" -}}
export EDITOR=nvim
{{ else -}}
export EDITOR=vim
{{ end -}}
export CLICOLOR=1
export LS_COLORS+=':ow=01;33'

# C++ (use clang by default if available)
{{ if lookPath "clang" -}}
export CC=clang
export CXX=clang++
{{ end -}}

{{ if .javaHome -}}
export JAVA_HOME={{ .javaHome | quote }}
{{ end -}}

# =============================
# PATH (single consolidated block)
# =============================
{{- $homeDir := .chezmoi.homeDir }}
{{- $paths := list }}

{{/* Home-relative paths (shared) */}}
{{- range (list "bin" "go/bin" ".cargo/bin" ".local/bin" ".local/share/coursier/bin") }}
{{-   $p := joinPath $homeDir . }}
{{-   if stat $p }}
{{-     $paths = mustAppend $paths $p }}
{{-   end }}
{{- end }}

{{/* System paths */}}
{{- range (list "/usr/local/go/bin") }}
{{-   if stat . }}
{{-     $paths = mustAppend $paths . }}
{{-   end }}
{{- end }}

{{/* CUDA */}}
{{- if .cudaPath }}
{{-   $paths = mustAppend $paths (printf "%s/bin" .cudaPath) }}
{{- end }}

{{/* Java */}}
{{- if .javaHome }}
{{-   $paths = mustAppend $paths (printf "%s/bin" .javaHome) }}
{{- end }}

{{/* Homeserver-specific */}}
{{- if .is_homeserver }}
{{-   if stat "/home/ankit/homeserver/bin" }}
{{-     $paths = mustAppend $paths "/home/ankit/homeserver/bin" }}
{{-   end }}
{{- end }}

{{ if $paths -}}
export PATH={{ toStrings $paths | join ":" }}:$PATH
{{ end -}}

{{ if .cudaPath -}}
export LD_LIBRARY_PATH="{{ .cudaPath }}/lib64${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
{{ end -}}

# ======================
# Tool initialization
# ======================

# Rust
[ -f "$HOME/.cargo/env" ] && . "$HOME/.cargo/env"

# Completions
{{ if lookPath "fzf" -}}
eval "$(fzf --bash)"
{{ end -}}
{{ if lookPath "terraform" -}}
complete -C "$(which terraform)" terraform
{{ end -}}
{{ if lookPath "uv" -}}
eval "$(uv generate-shell-completion bash)"
{{ end -}}
{{ if lookPath "uvx" -}}
eval "$(uvx --generate-shell-completion bash)"
{{ end -}}

# Quake terminal session
if [ -n "${QUAKE}" ] && [ -z "${TMUX}" ]; then
  tmux new-session -A -s quake
fi

# Aliases (after PATH is built)
[ -f "$HOME/.alias.sh" ] && source "$HOME/.alias.sh"
